<!DOCTYPE html>
<html lang="en">
<head>
<meta name="description" content="Free DNA Analyzer - GC content, ORFs, protein translation, codon usage, restriction sites, melting temperature, CpG islands, primer design, and more.">
<meta name="keywords" content="DNA analysis, GC content, ORF finder, protein translation, codon usage, restriction sites, melting temperature, CpG island detection, primer design">
<meta name="author" content="Your Name">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ultimate DNA Analyzer</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body{max-width:980px;margin:18px auto;font-family:Arial,Helvetica,sans-serif;}
  textarea{width:100%;height:120px;font-family:monospace;font-size:14px;padding:8px;}
  button{margin:6px 6px 12px 0;padding:8px 12px;border-radius:6px;border:none;background:#2f7be2;color:#fff;cursor:pointer;}
  .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .box{background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 5px rgba(0,0,0,0.06);margin-top:12px}
  .results pre{background:#f4f6f8;padding:8px;border-radius:6px}
</style>
</head>
<body>
  <h1>Ultimate DNA Analyzer</h1>

  <div class="box">
    <label><strong>Enter DNA (A,T,G,C):</strong></label><br/>
    <textarea id="dna_seq" placeholder="Paste or type sequence..."></textarea>
    <div class="row">
      <button id="btnAnalyze">Analyze</button>
      <button id="btnLoad">Load File</button>
      <button id="btnClear">Clear</button>
      <button id="btnSample">Sample</button>
      <button id="btnReverse">Reverse</button>
      <button id="btnCopyResults">Copy Results</button>
      <button id="btnSaveProject">Save Project</button>
      <button id="btnListProjects">Load Project</button>
      <button id="btnPDF">Export PDF</button>
    </div>
    <input type="file" id="fileInput" accept=".txt" style="display:none"/>
  </div>

  <div id="error" style="color:#b00020;margin-top:10px;display:none"></div>
  <div id="resultsArea" class="results"></div>

<script>
const $ = id => document.getElementById(id);

const dnaInput = $('dna_seq');
const fileInput = $('fileInput');
const resultsArea = $('resultsArea');
const err = $('error');

$('btnLoad').onclick = ()=> fileInput.click();
fileInput.onchange = (e)=> {
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=> dnaInput.value = r.result.toUpperCase().replace(/[^ATGC]/g,'');
  r.readAsText(f);
};

$('btnClear').onclick = ()=> { dnaInput.value=''; resultsArea.innerHTML=''; err.style.display='none'; };
$('btnSample').onclick = ()=> dnaInput.value = 'ATGCGTACGTTAGCTAGCTAGCGTAGCTAGCTAAATCGATCGTAGCTAGCTAG';
$('btnReverse').onclick = ()=> dnaInput.value = dnaInput.value.split('').reverse().join('');
$('btnCopyResults').onclick = ()=> { if(!resultsArea.innerText) return alert('No results'); navigator.clipboard.writeText(resultsArea.innerText).then(()=>alert('Copied')) };

async function analyzeSequence(seq){
  const resp = await fetch('/analyze',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({sequence: seq})});
  if(!resp.ok){
    const j = await resp.json(); throw new Error(j.error || 'Analysis failed');
  }
  return await resp.json();
}

function renderResults(data){
  const full = data.full || {};
  resultsArea.innerHTML = '';
  const out = [];
  out.push(`<div class="box"><h2>Summary</h2><pre>${data.text}</pre></div>`);
  out.push(`<div class="box"><h3>Nucleotide counts</h3>
    <ul><li>A: ${full.counts?.A||0}</li><li>T: ${full.counts?.T||0}</li><li>G: ${full.counts?.G||0}</li><li>C: ${full.counts?.C||0}</li></ul>
    <p><strong>GC:</strong> ${full.gc_content||0}%</p>
    <p><strong>Mol. weight:</strong> ${full.molecular_weight||''} Da</p></div>`);

  out.push(`<div class="box"><h3>Complements</h3><pre>${full.complement||''}</pre><h3>Reverse</h3><pre>${full.reverse_complement||''}</pre></div>`);

  out.push(`<div class="box"><h3>Charts</h3><canvas id="chartN" width="700" height="160"></canvas><canvas id="chartGC" width="700" height="160"></canvas></div>`);

  out.push(`<div class="box"><h3>Protein translation</h3><pre>${full.protein||'None'}</pre></div>`);

  out.push(`<div class="box"><h3>ORFs</h3><pre>${JSON.stringify(full.orfs||[],null,2)}</pre></div>`);

  out.push(`<div class="box"><h3>Repeats (2)</h3><pre>${JSON.stringify(full.repeats2||{},null,2)}</pre><h3>Repeats (3)</h3><pre>${JSON.stringify(full.repeats3||{},null,2)}</pre></div>`);

  out.push(`<div class="box"><h3>Codon usage</h3><pre>${JSON.stringify(full.codon_usage||{},null,2)}</pre></div>`);
  out.push(`<div class="box"><h3>Restriction sites</h3><pre>${JSON.stringify(full.restriction_sites||{},null,2)}</pre></div>`);
  out.push(`<div class="box"><h3>Melting temp</h3><pre>${full.melting_temp||'N/A'}</pre></div>`);
  out.push(`<div class="box"><h3>CpG islands (approx)</h3><pre>${JSON.stringify(full.cpg_islands||[],null,2)}</pre></div>`);
  out.push(`<div class="box"><h3>Primers (18-22nt)</h3><pre>${JSON.stringify(full.primers||[],null,2)}</pre></div>`);

  if(full.prot_png){
    out.push(`<div class="box"><h3>Protein structure preview</h3><img src="/${full.prot_png}" alt="protein" style="max-width:100%"/><br/><a href="/${full.prot_png}" download><button>Download Protein PNG</button></a></div>`);
  }

  resultsArea.innerHTML = out.join('');

  // draw charts
  try{
    const counts = full.counts || {'A':0,'T':0,'G':0,'C':0};
    const ctx = document.getElementById('chartN').getContext('2d');
    new Chart(ctx, { type:'bar', data:{ labels:['A','T','G','C'], datasets:[{ label:'Counts', data:[counts.A||0,counts.T||0,counts.G||0,counts.C||0], backgroundColor:['#4caf50','#f44336','#2196f3','#ffeb3b'] }] }, options:{ responsive:true } });

    const gcData = data.gc_skew || [];
    const ctx2 = document.getElementById('chartGC').getContext('2d');
    new Chart(ctx2, { type:'line', data:{ labels: gcData.map((v,i)=>i+1), datasets:[{ label:'GC skew', data: gcData, borderColor:'purple', fill:false }] }, options:{ scales:{ y:{ min:-1, max:1 } } } });
  }catch(e){ console.warn(e) }
}

$('btnAnalyze').onclick = async ()=>{
  err.style.display = 'none';
  const seq = dnaInput.value.trim();
  if(!seq){ err.innerText='Enter sequence first'; err.style.display='block'; return; }
  try{
    const data = await analyzeSequence(seq);
    renderResults(data);
  }catch(e){
    err.innerText = e.message || 'Analysis error'; err.style.display='block';
  }
};

// Save project (minimal)
$('btnSaveProject').onclick = async ()=>{
  const name = prompt('Project name:'); if(!name) return;
  const seq = dnaInput.value.trim(); if(!seq) return alert('No sequence');
  const analyzeResp = await analyzeSequence(seq);
  const results = analyzeResp.full || {};
  const r = await fetch('/save_project', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name:name, results: results})});
  const j = await r.json();
  if(j.ok) alert('Saved: '+j.filename); else alert('Save failed: '+(j.error||''));
};

$('btnListProjects').onclick = async ()=>{
  const r = await fetch('/list_projects'); const j = await r.json();
  if(!j.projects || !j.projects.length){ alert('No saved projects'); return; }
  const name = prompt('Enter project filename to load (choose from console):\\n' + j.projects.join('\\n'));
  if(!name) return;
  const rr = await fetch('/load_project?name=' + encodeURIComponent(name)); const jj = await rr.json();
  if(jj.ok){ dnaInput.value = jj.data.sequence || ''; $('btnAnalyze').click(); } else alert('Load failed');
};

$('btnPDF').onclick = async ()=>{
  const seq = dnaInput.value.trim(); if(!seq) return alert('Enter sequence');
  const analyzeResp = await analyzeSequence(seq);
  const results = analyzeResp.full || {};
  const r = await fetch('/download_pdf', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({results: results})});
  if(!r.ok){ alert('PDF failed'); return; }
  const blob = await r.blob(); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'dna_report.pdf'; a.click(); URL.revokeObjectURL(url);
};
</script>
</body>
</html>
